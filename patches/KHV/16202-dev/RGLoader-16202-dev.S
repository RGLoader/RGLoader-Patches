# RGLoader patches file
# Patches follow same format as XeBuild, but with RGLP at start
# When used with RGLoader patch engine, refer to the ini for patches offset in NAND
# [4byte offset] [4byte patch count] [4byte patch]...

# Devkit 16202 patches

.include "..\\..\\macros.S"

		.globl _start
_start:

# ============================================================================
#	RGLP header
	.long 0x52474C50  #"RGLP"
# ============================================================================

.ifdef disable_bootanim
	.print "  --- BOOTANIM DISABLED ---"
	.include "RGLoader-16202_disable_bootanim.S"
.endif

.ifdef NOFCRT
	.print "  --- FCRT DISABLED ---"
	.include "RGLoader-16202_nofcrt.S"
.endif

.ifdef NOMU
	.print "  --- MU DISABLED ---"
	.include "RGLoader-16202_noMU.S"
.endif

.ifdef SYSROOTHDD
	.print "  --- SYSTEM ROOT MAPPED TO HDD ---"
	.include "RGLoader-16202_sysroot_hdd.S"
.endif

.ifdef kd_1retry
	.print "  --- KD retries patched to 1 ---"
	.include "RGLoader-16202_kd_1retry.S"
.endif


#----------------------------------------------------------

# .include "RGLoader-16202-uartPOST.S"

# ============================================================================
#       Fix controller unsync bug that still exists in 16202   
# ============================================================================
	KMAKEPATCH 0x80127E64
0:
	ori		%r9, %r9, 8
	stb		%r9, 0x6F(%r31)
9:

#----------------------------------------------------------

# ============================================================================
#       Retail XEX2 AES key   
# note: should be static
# ============================================================================
	KMAKEPATCH 0x800000F0
0:
	.long 0x20B185A5
	.long 0x9D28FDC3
	.long 0x40583FBB
	.long 0x0896BF91
9:

# ============================================================================
#	HV Flag fixing function
# note: store at empty space
# ============================================================================
	KMAKEPATCH 0x8000AF60 
0:
	lhz     %r3, 0x6(%r0)  # load flag byte into r3
	li      %r4, 0x20
	andc    %r3, %r3, %r4 # clear bit
	sth     %r3, 0x6(%r0)      # store new flag
	cmpldi   %r21,  0    # do what we patched
	ba      0x18BC  #CHANGE THIS ADDR TO JUMP BACK
9:

# ============================================================================
#	HV jump to flag fixer
# ============================================================================
	KMAKEPATCH 0x800018B8 
0:
	ba  0xAF60      #(CHANGE THE ADDR TO FLAG FIXING FUNCTIONS ADDR) ^
9:


# ============================================================================
#  KV check patches - Hvxkeyshmacsha
# ============================================================================
	KMAKEPATCH 0x80004D1C  # First check on
0:
	nop
9:

# ============================================================================
#	HV Patch flag check
# ============================================================================
	KMAKEPATCH 0x80006FE4
0:
	nop  #nop out machine check
9:

#============================================================================
#	HV patch jump
# ============================================================================
	KMAKEPATCH 0x80006F88
0:
	li %r3, 0 
9:

	KMAKEPATCH 0x8000700C
0:
	nop
9:

# ============================================================================
#       Patch XEX flag
# ============================================================================

	KMAKEPATCH 0x800070C0 
0:
	li %r3, 0
9:

	KMAKEPATCH 0x8000744C
0:
	li %r4, 0x8
	li %r3, 0
9:

#============================================================================
#	HV Patch blow fuses              
# ============================================================================
	KMAKEPATCH 0x80009F00 
0:
	li %r3, 1 
	blr
9:

# ============================================================================
#	MachineCheck (mfspr   r3, LPCR)
# ============================================================================
	KMAKEPATCH 0x80000218
0:
	.long 0x00000000
9:

# ============================================================================
#       DVDAuth2 retail key
# note: should stay constant
# ============================================================================
	KMAKEPATCH 0x80010d08
0:
	.long 0xD1E3B33A
	.long 0x6C1EF770
	.long 0x5F6DE93B
	.long 0xB6C0DC71
9:

# ============================================================================
#	HvxDvdAuthRecordXControl
# ============================================================================
	KMAKEPATCH 0x80026BEC 
0:
	li  %r3, 1
9:

# ============================================================================
#       HV DAE 
# ============================================================================
	KMAKEPATCH 0x80028F6C
0:
	li    %r3, 0
	nop
9:

# ============================================================================
# 	Check if XEX decrypted properly, if not swap the key
# ============================================================================
	KMAKEPATCH 0x80029B70
0:
	cmpldi  cr6,  %r28,  0
	beq     cr6,  0x30          
	cmpwi   cr6,  %r3,  0
	bne     cr6,  0x10
	li      %r4,  0xF0
	b 0x18
	nop
9:

# ============================================================================
#	HvxSetImagePageTableEntry memory addr check
# ============================================================================
	KMAKEPATCH 0x80029D28
0:
	nop
9:

# ============================================================================
#	HvxCreateImageMapping hash check
# ============================================================================
	KMAKEPATCH 0x8002C704 
0:
	b  0x10
9:

#-----------------------------------------------------------------------

# ============================================================================
#	HvxCreateImageMapping HV XEX region check 
# ============================================================================
	KMAKEPATCH 0x8002C7FC
0:
	nop
9:


# ============================================================================
#	HvxExpansionInstall sig check
# ============================================================================
	KMAKEPATCH 0x80030BAC
0:
	nop
9:

# ============================================================================
#	HvxExpansionInstall hash? (uses memcmp) check
# ============================================================================
	KMAKEPATCH 0x80030C2C 
0:
	nop
9:


#------------
#=============================================================================
# Kernel patches
#=============================================================================
#------------


# ============================================================================
#	Patch XEX Restrictions check
# ============================================================================

	KMAKEPATCH 0x800A2C78
0:
	li     %r3,  1
9:

	KMAKEPATCH 0x800A0CDC
0:
	b   0x18
9:


# ============================================================================
#       SataCdRomAuthenticationExSequence
# ============================================================================
	KMAKEPATCH 0x800C5128
0:
	b   0x38
9:

#----------------------------------------------------------

# ============================================================================
#	SataCdRomActivateHCDFRuntimePatch TSST signature check
# ============================================================================
	KMAKEPATCH 0x800C4B3C
0:
	b   0x184
9:

# ============================================================================
#	SataCdRomActivateHCDFRuntimePatch blacklisted drive check
# ============================================================================
	KMAKEPATCH 0x800C4B58
0:
	b   0x168
9:


# ============================================================================
#	XexpVerifyMedia Type
# ============================================================================
	KMAKEPATCH 0x8009EC0C
0:
	li   %r3,  1
9:

# ============================================================================
#	XexpVerifyXexHeaders
# ============================================================================
	KMAKEPATCH 0x800A0720
0:
	li   %r3,  1
9:

# ============================================================================
#	XexpVerifyXexHeaders  (patch out XeKeysVerifyPIRSSignature)
# ============================================================================
	KMAKEPATCH 0x800A06C4
0:
	li   %r3,  1 
9:

# ============================================================================
#	XexpVerifyMinimumVersion
# ============================================================================
	KMAKEPATCH 0x800A14E0
0:
	li   %r3,  1
9:

# ============================================================================
#	XexpLoadFile
# ============================================================================
	KMAKEPATCH 0x800A2DDC
0:
	li   %r3,  1
9:


#-----------------------------------------------------------------------

#=============================================================================
#       nop out Shadowbooting on startup 
#  (usually stays constant)
#=============================================================================
	KMAKEPATCH 0x8008180C
0:
	nop
9:

#=============================================================================
#       disable shadow booting function  
#  (usually stays constant)
#=============================================================================
	KMAKEPATCH 0x80081348 
0:
	li %r3, 0
	blr
9:


#-----------------------------------------------------------------------



# ============================================================================
#	XeKeysVerifyRSASignature
# ============================================================================
	KMAKEPATCH 0x80148BA0
0:
	nop
9:
	KMAKEPATCH 0x80148BD4
0:
	li   %r3, 1
9:


# ============================================================================
#	SataCdRomVerifyDVDX2AuthoringSignature
# ============================================================================
	KMAKEPATCH 0x800C30C8
0:
	li   %r3, 1
9:

# ============================================================================
#	SataDiskAuthenticateDevice
# ============================================================================
	KMAKEPATCH 0x801A9730 
0:
	li   %r3, 1
9:

#==========THE FOLLOWING ARE NOT IMPORTANT AT THE MOMENT=====

# ============================================================================
#	XeKeysVerifyPIRSSignature
# ============================================================================
	KMAKEPATCH 0x80148C74
0:
	li    %r3, 1
9:

# ============================================================================
#	XeKeysConsoleSignatureVerification
# note: jumps down to 'li r3, 1'
# ============================================================================
	KMAKEPATCH 0x8014AC74
0:
	b    0x128  #make sure this lands on the li r3, 1
9:

# ============================================================================
#	StfsMapNewBlock hash mismatch
# ============================================================================
	KMAKEPATCH 0x800E1D2C
0:
	b    0x34  #patch to unconditional branch
9:

# ============================================================================
#	SvodMapNewBlock hash mismatch 
# ============================================================================
	KMAKEPATCH 0x80185170 
0:
	b 0x30  #patch to unconditional branch
9:

# ============================================================================
#	SvodPartiallyCachedRead hash mismatch
# ============================================================================
	KMAKEPATCH 0x80185484
0:
	nop
9:

# ============================================================================
#	Load RGLoader.xex after XAM
# ============================================================================

KMAKEPATCH 0x800819D8
0:
	KMAKEBRANCHL 0x801B9FD8
9:

KMAKEPATCH 0x801B9FD8
0:
	bge cr6, loadxex
	blr
	loadxex:
	#loadhere

	lis %r3, (0xFFFF0000 & (0x801B9FD8 + (stringloc - 0b))) >> 16 #Higher 16
	ori %r3, %r3, 0xFFFF & (0x801B9FD8 + (stringloc - 0b)) #Lower 16
	li %r4, 8
	li %r5, 0
	li %r6, 0
	KMAKEBRANCHL 0x800A3C38 #XexLoadImage

	#return
	KMAKEBRANCH 0x800819F8

	stringloc:
	.string "\\Device\\Flash\\RGLoader.xex"
	.align 4
9:
  

# ============================================================================
	.long 0xffffffff
	.end
# ============================================================================
